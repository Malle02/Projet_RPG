package MonPackage;

import java.util.Scanner;
import java.util.Random;
import java.util.InputMismatchException;

public class Game {
    private Character player;
    private WeaponStore store;
    private String[][] dungeon;
    private int playerX, playerY;
    private final int dungeonSize = 5;
    private Monster currentMonster;
    private Obstacle currentObstacle;
    private Random random = new Random();
    private boolean gameRunning = true;
    

    public Game() {
        store = new WeaponStore();
        dungeon = new String[dungeonSize][dungeonSize];
        initializeDungeon();
        playerX = 0;
        playerY = 0;
    }

    private void displayClassOptions() {
        System.out.println("\n--- Choix de la classe ---");
        System.out.println("1. Sorcier üßô : Ma√Ætre des sorts magiques, il peut lancer des sorts puissants (au co√ªt de mana) pour infliger des d√©g√¢ts √©lev√©s.");
        System.out.println("   - Capacit√© initiale : 'Boule de Feu' inflige 30 points de d√©g√¢ts pour 20 de mana.");
        System.out.println("   - Capacit√© au Niveau 2 : 'Temp√™te de Glace' g√®le les ennemis pour un tour.");
        System.out.println("2. Guerrier ü™ì : Combattant puissant, il peut entrer en √©tat de 'Rage' pour infliger des d√©g√¢ts suppl√©mentaires et r√©sister aux attaques.");
        System.out.println("   - Capacit√© initiale : 'Rage' augmente les d√©g√¢ts pour un tour.");
        System.out.println("   - Capacit√© au Niveau 2 : 'Bouclier de Fer' augmente la d√©fense.");
        System.out.println("3. Elfe üèπ : Agile et pr√©cis, il peut esquiver certaines attaques et infliger des d√©g√¢ts suppl√©mentaires avec des arcs.");
        System.out.println("   - Capacit√© initiale : Bonus de d√©g√¢ts avec l'arc et chance d'esquive.");
        System.out.println("   - Capacit√© au Niveau 2 : 'Invisibilit√©' pour √©chapper aux ennemis.");
        System.out.println("\nVeuillez choisir votre classe en tapant 'Sorcier', 'Guerrier' ou 'Elfe'.");
    }

    private void displayInstructions() {
        System.out.println("\n--- Instructions du jeu ---");
        System.out.println("Bienvenue dans le donjon !");
        System.out.println("Vous incarnez un aventurier qui doit trouver la sortie du donjon tout en affrontant des monstres et en collectant des tr√©sors.");
        System.out.println("Commandes principales :");
        System.out.println("1. Acheter des armes pour vous √©quiper.");
        System.out.println("2. Explorer le donjon pour d√©couvrir de nouveaux endroits.");
        System.out.println("3. Voir l'√©tat de votre personnage, y compris sant√©, mana, XP et potions.");
        System.out.println("4. Afficher la carte du donjon pour vous rep√©rer.");
        System.out.println("5. Quitter le jeu.");
        System.out.println("D√©placez-vous dans le donjon en utilisant les commandes 'haut', 'bas', 'gauche', 'droite'.");
        System.out.println("Bonne chance, et faites preuve de bravoure ! üí™");
    }

    public void start() {
        Scanner scanner = new Scanner(System.in);
        System.out.println("üéÆ Bienvenue dans le RPG ASCII Art ! üéÆ");
        displayInstructions();
        
        while (gameRunning) {
            try {
                System.out.print("Entrez le nom de votre personnage : ");
                String name = scanner.nextLine();
                String characterClass;
                
                displayClassOptions(); // Affiche les options de classe avec les descriptions
                
                while (true) {
                    System.out.print("Choisissez une classe (Sorcier, Elfe, Guerrier) : ");
                    characterClass = scanner.nextLine();
                    if (characterClass.equals("Sorcier") || characterClass.equals("Elfe") || characterClass.equals("Guerrier")) {
                        break;
                    } else {
                        System.out.println("Classe invalide. Veuillez choisir entre Sorcier, Elfe ou Guerrier.");
                    }
                }

                player = new Character(name, characterClass);
                System.out.println("\nVotre aventure commence ! Vous √™tes un(e) " + player.getCharacterClass() + " pr√™t(e) √† explorer le donjon... üåü");

                gameLoop(scanner);
            } catch (InputMismatchException e) {
                System.out.println("Entr√©e invalide ! Veuillez essayer de nouveau.");
                scanner.nextLine(); 
            }
        }
    }
    


    public static void nextLevel() {
        System.out.println("üö™ Vous avez termin√© ce niveau du donjon ! F√©licitations !");
        
        // Propose de rejouer ou d'arr√™ter
      
        Game gameInstance = new Game();
        gameInstance.endGameOptions(new Scanner(System.in));
    }
    
    
    
    private void resetDungeon() {
        dungeon = new String[dungeonSize][dungeonSize]; 
        initializeDungeon(); // R√©initialise le contenu du donjon
        playerX = 0; // Repositionne le joueur en haut √† gauche
        playerY = 0;
    }

    
    
    // M√©thode endGameOptions mise √† jour pour inclure la sortie r√©ussie
    private void endGameOptions(Scanner scanner) {
        System.out.println("\n--- Fin du Jeu ---");
        System.out.println("1. Rejouer avec les m√™mes donn√©es üîÑ");
        System.out.println("2. Voir vos statistiques finales üìú");
        System.out.println("3. Quitter le jeu ‚ùå");

        try {
            int choice = scanner.nextInt();
            switch (choice) {
                case 1:
                    resetDungeon(); // R√©initialise uniquement le donjon
                    System.out.println("Le donjon a √©t√© r√©initialis√©. Bonne chance pour cette nouvelle tentative !");
                    gameLoop(scanner); // Reprend la boucle de jeu
                    break;
                case 2:
                    player.displayStatus(); // Affiche le statut final du joueur
                    break;
                case 3:
                    System.out.println("Merci d'avoir jou√© ! √Ä bient√¥t !");
                    gameRunning = false; // Met fin √† la boucle principale
                    break;
                default:
                    System.out.println("Choix invalide. Veuillez entrer un nombre entre 1 et 3.");
            }
        } catch (InputMismatchException e) {
            System.out.println("Erreur d'entr√©e. Veuillez entrer un nombre valide.");
            scanner.nextLine(); 
        }
    }



    // M√©thode resetGame() pour red√©marrer le jeu
    private void resetGame() {
        dungeon = new String[dungeonSize][dungeonSize];
        initializeDungeon();
        playerX = 0;
        playerY = 0;
        
        // R√©initialise le joueur au niveau 1 avec 0 XP, sant√© et mana max
        player.resetCharacter();
        
        start();
    }



    private void gameLoop(Scanner scanner) {
        while (player.isAlive() && gameRunning) {
            System.out.println("\n--- Menu ---");
            System.out.println("1: Acheter une arme üõí");
            System.out.println("2: Explorer le donjon üè∞");
            System.out.println("3: Afficher l'√©tat du personnage üßô");
            System.out.println("4: Afficher la carte du donjon üó∫Ô∏è");
            System.out.println("5: Quitter ‚ùå");

            try {
                int choice = scanner.nextInt();
                switch (choice) {
                    case 1:
                        buyWeapon(scanner);
                        break;
                    case 2:
                        exploreDungeon(scanner);
                        break;
                    case 3:
                        player.displayStatus();
                        System.out.println(player.asciiArt());
                        break;
                    case 4:
                        displayDungeon();
                        break;
                    case 5:
                        System.out.println("Merci d'avoir jou√© ! √Ä bient√¥t pour de nouvelles aventures. üéâ");
                        gameRunning = false;
                        break;
                    default:
                        System.out.println("Choix invalide. Veuillez entrer un chiffre entre 1 et 5.");
                }
            } catch (InputMismatchException e) {
                System.out.println("Entr√©e invalide. Veuillez entrer un chiffre.");
                scanner.nextLine(); // Clear scanner buffer
            }
        }

        if (!player.isAlive()) {
            System.out.println("‚ò†Ô∏è Vous avez √©t√© vaincu. Fin de l'aventure. ‚ò†Ô∏è");
            player.resetCharacter(); // R√©initialise le personnage
            endGameOptions(scanner); // Propose de rejouer
            
        }

    }

    private void buyWeapon(Scanner scanner) {
        store.printWeapons();
        System.out.print("Choisissez une arme (index) : ");
        try {
            int index = scanner.nextInt();
            if (index < 0 || index >= store.getWeapons().size()) {
                System.out.println("Arme invalide.");
                return;
            }

            Weapon weapon = store.getWeapons().get(index);
            if (player.getMoney() >= weapon.getPrice()) {
                player.reduceMoney(weapon.getPrice());
                player.addWeapon(weapon);
                System.out.println("Vous avez achet√© " + weapon.getName() + " ! ‚öîÔ∏è");
            } else {
                System.out.println("Vous n'avez pas assez d'argent. üí∏");
            }
        } catch (InputMismatchException e) {
            System.out.println("Erreur : veuillez entrer un num√©ro d'index valide.");
            scanner.nextLine(); 
        }
    }

    private void exploreDungeon(Scanner scanner) {
        boolean exploring = true;

        while (exploring && player.isAlive()) {
            displayDungeon();
            System.out.println("Vous √™tes √† la position (" + playerX + ", " + playerY + ").");

            checkInteraction(scanner);

            if ("üö™".equals(dungeon[playerX][playerY])) {
                System.out.println("üéâ F√©licitations, vous avez trouv√© la sortie ! Vous √™tes un h√©ros ! üéâ");
                endGameOptions(scanner); 
                exploring = false;
            }


            System.out.println("D√©placez-vous : (haut, bas, gauche, droite)");
            String direction = scanner.next().toLowerCase();
            movePlayer(direction);
        }
    }

    private void movePlayer(String direction) {
        int newX = playerX;
        int newY = playerY;

        switch (direction) {
            case "haut":
                newX = Math.max(playerX - 1, 0);
                break;
            case "bas":
                newX = Math.min(playerX + 1, dungeonSize - 1);
                break;
            case "gauche":
                newY = Math.max(playerY - 1, 0);
                break;
            case "droite":
                newY = Math.min(playerY + 1, dungeonSize - 1);
                break;
            default:
                System.out.println("Direction invalide. Veuillez choisir 'haut', 'bas', 'gauche' ou 'droite'.");
                return;
        }

        playerX = newX;
        playerY = newY;
    }

    private void checkInteraction(Scanner scanner) {
        if ("üëπ".equals(dungeon[playerX][playerY])) {
            currentMonster = new Monster();
            System.out.println("Un monstre appara√Æt ! üëπ Pr√©parez-vous au combat !");
            combat(scanner);
            if (!currentMonster.isAlive()) {
                dungeon[playerX][playerY] = "‚¨õ";
            }
        } else if ("ü™®".equals(dungeon[playerX][playerY])) {
            currentObstacle = new Obstacle();
            System.out.println("Un obstacle bloque votre chemin ! ü™®");
            destroyObstacle(scanner);
        } else if ("üí∞".equals(dungeon[playerX][playerY])) {
            System.out.println("Vous avez trouv√© un tr√©sor ! üí∞ +20 pi√®ces d'or.");
            player.reduceMoney(-20); // Ajoute de l'argent
            dungeon[playerX][playerY] = "‚¨õ";
        } else if ("‚ö†Ô∏è".equals(dungeon[playerX][playerY])) {
            System.out.println("A√Øe ! Vous √™tes tomb√© dans un pi√®ge ! ‚ö†Ô∏è -10 Sant√©.");
            player.hit(10); // Perte de sant√©
            dungeon[playerX][playerY] = "‚¨õ";
        }
    }

    private void combat(Scanner scanner) {
        while (player.isAlive() && currentMonster.isAlive()) {
            System.out.print("Attaquer (A), D√©fendre (D), Utiliser une potion (P), ou Fuir (F) ? ");
            String action = scanner.next().toUpperCase();

            if ("A".equals(action)) {
                if (!player.getInventory().isEmpty()) {
                    Weapon weapon = player.getInventory().get(0);
                    weapon.attack(currentMonster);
                    System.out.println("Vous attaquez le monstre avec " + weapon.getName() + "! üëπ Sant√© du monstre : " + currentMonster.getHealth());
                } else if (player.getCharacterClass().equals("Sorcier")) {
                    player.castSpell(currentMonster);
                } else {
                    System.out.println("Vous n'avez pas d'arme ! Le monstre vous attaque. üò±");
                    player.hit(currentMonster.attack());
                }
            } else if ("D".equals(action)) {
                System.out.println("Vous vous d√©fendez et r√©duisez les d√©g√¢ts de moiti√©.");
                player.hit(currentMonster.attack() / 2);
            } else if ("P".equals(action)) {
                if (player.usePotion()) {
                    System.out.println("Vous avez utilis√© une potion pour r√©cup√©rer 20 points de sant√©.");
                } else {
                    System.out.println("Vous n'avez pas de potion. üò¢");
                }
            } else if ("F".equals(action)) {
                System.out.println("Vous fuyez le combat ! üèÉ‚Äç‚ôÇÔ∏è Vous √™tes renvoy√© plus loin dans le donjon.");
                movePlayerToDistantSpot();
                break;
            } else {
                System.out.println("Action invalide. Veuillez entrer 'A', 'D', 'P', ou 'F'.");
            }

            if (currentMonster.isAlive()) {
                player.hit(10);
                System.out.println("Le monstre riposte ! üòà Votre sant√© : " + player.getHealth());
            }
        }

        if (!currentMonster.isAlive()) {
            System.out.println("Vous avez vaincu le monstre ! üéâ Gagn√© 20 XP.");
            player.addXP(20);
        }
    }

    private void movePlayerToDistantSpot() {
        int randomX, randomY;
        do {
            randomX = random.nextInt(dungeonSize);
            randomY = random.nextInt(dungeonSize);
        } while (Math.abs(randomX - (dungeonSize - 1)) + Math.abs(randomY - (dungeonSize - 1)) < 3); // V√©rifie que le joueur est loin de la sortie

        playerX = randomX;
        playerY = randomY;
        System.out.println("Vous avez √©t√© d√©plac√© √† une position √©loign√©e : (" + playerX + ", " + playerY + ").");
    }

    private void destroyObstacle(Scanner scanner) {
        while (true) {
            System.out.print("D√©truire l'obstacle (D) ou fuir (F) ? ");
            String action = scanner.next().toUpperCase();

            if ("D".equals(action)) {
                if (!player.getInventory().isEmpty()) {
                    Weapon weapon = player.getInventory().get(0);
                    weapon.attack(currentObstacle);
                    System.out.println("Vous d√©truisez l'obstacle avec " + weapon.getName() + " ! ü™ì");
                    dungeon[playerX][playerY] = "‚¨õ";
                } else {
                    System.out.println("Vous n'avez pas d'arme pour d√©truire l'obstacle. Vous perdez de la sant√©.");
                    player.hit(10);
                }
                break;
            } else if ("F".equals(action)) {
                System.out.println("Vous avez choisi de fuir !");
                break;
            } else {
                System.out.println("Action invalide. Veuillez choisir 'D' pour d√©truire ou 'F' pour fuir.");
            }
        }
    }

    private void initializeDungeon() {
        for (int i = 0; i < dungeonSize; i++) {
            for (int j = 0; j < dungeonSize; j++) {
                int rand = random.nextInt(10);
                if (rand < 2) dungeon[i][j] = "üëπ"; 
                else if (rand < 4) dungeon[i][j] = "ü™®"; 
                else if (rand < 5) dungeon[i][j] = "üí∞"; 
                else if (rand < 6) dungeon[i][j] = "‚ö†Ô∏è"; // Pi√®ge
                else dungeon[i][j] = "‚¨õ"; // Case vide
            }
        }
        dungeon[dungeonSize - 1][dungeonSize - 1] = "üö™"; // Position de sortie
    }

    private void displayDungeon() {
        System.out.println("Carte du donjon :");
        for (int i = 0; i < dungeonSize; i++) {
            for (int j = 0; j < dungeonSize; j++) {
                if (i == playerX && j == playerY) {
                    System.out.print("üßç ");
                } else {
                    System.out.print(dungeon[i][j] + " ");
                }
            }
            System.out.println();
        }
    }
    
 

}
